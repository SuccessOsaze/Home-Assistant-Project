#Virtual Automations (relevant for future testing)
# - id: "virtual_motion_lights_test"
#   alias: Virtual Motion Lights Test
#   description: "Turn on bulb when motion detected in dark conditions"
#   trigger:
#     - platform: state
#       entity_id: input_boolean.virtual_motion
#       to: 'on'
#   condition:
#     - condition: numeric_state
#       entity_id: input_number.virtual_lux
#       below: 100
#   action:
#     - service: light.turn_on
#       target:
#         entity_id: light.virtual_smart_bulb
#       data:
#         brightness_pct: 50
#         color_temp: 370
#     - service: notify.persistent_notification
#       data:
#         message: "Virtual motion detected! Bulb turned on at {{ now().strftime('%H:%M:%S') }}"
        

# Real Device Automations 

#1. Smart Plug Logic (Living Room Power Policy)

# ─────────────────────────────────────────────────────────────
# REQUIRED HELPERS — declare these in configuration.yaml first
# ─────────────────────────────────────────────────────────────
# input_boolean:
#   smart_plug_enable:
#     name: Smart Plug Enable
#     initial: on
#     icon: mdi:power
#   living_room_power_allowed:
#     name: Living Room Power Allowed
#     initial: off
#     icon: mdi:home-lightning-bolt
#   living_room_motion_enable:
#     name: Living Room Motion Enable
#     initial: on
#     icon: mdi:motion-sensor
#   living_room_manual_mode:
#     name: Living Room Manual Mode
#     initial: off
#     icon: mdi:hand-back-right
# ─────────────────────────────────────────────────────────────

# 1. Living Room Power Policy
- alias: Living Room Power Policy
  description: "Controls power availability based on motion, load, and schedule"
  trigger:
    - platform: numeric_state
      entity_id: sensor.smart_plug_power
      below: 5
      for: "00:02:00"
      id: low_power

    - platform: state
      entity_id: binary_sensor.sensor_presence
      to: 'off'
      for: "00:02:00"
      id: no_motion

    # FIX: Added presence-back trigger so power re-enables when someone
    # returns during the active window (sunset → 23:00), not just at sunset.
    - platform: state
      entity_id: binary_sensor.sensor_presence
      to: 'on'
      id: motion_returned

    - platform: sun
      event: sunset
      id: on_time

    - platform: time
      at: "23:00:00"
      id: off_time

  condition:
    - condition: state
      entity_id: input_boolean.smart_plug_enable
      state: 'on'

  action:
    - choose:
        # ─── DISALLOW POWER ───
        - conditions:
            - condition: or
              conditions:
                - condition: trigger
                  id: low_power
                - condition: trigger
                  id: no_motion
                - condition: trigger
                  id: off_time
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.living_room_power_allowed

            - service: switch.turn_off
              target:
                entity_id: switch.smart_plug

            - service: system_log.write
              data:
                level: info
                # FIX: Inline trigger.id directly — no variables block needed
                message: "Living room power DISABLED due to {{ trigger.id }}"

        # ─── ALLOW POWER (sunset) ───
        - conditions:
            - condition: trigger
              id: on_time
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.living_room_power_allowed

            - service: switch.turn_on
              target:
                entity_id: switch.smart_plug

            - service: system_log.write
              data:
                level: info
                message: "Living room power ENABLED at sunset"

        # ─── ALLOW POWER (presence returned within active window) ───
        # FIX: Re-enable power if someone comes home between sunset and 23:00
        - conditions:
            - condition: trigger
              id: motion_returned
            - condition: sun
              which: sunset
              before: "00:00:00"    # after sunset has already passed today
            - condition: time
              before: "23:00:00"
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.living_room_power_allowed

            - service: switch.turn_on
              target:
                entity_id: switch.smart_plug

            - service: system_log.write
              data:
                level: info
                message: "Living room power RE-ENABLED due to presence returning"

  mode: queued


# 2. Living Room Motion Lighting (UX Logic)
- id: "living_room_motion_light"
  alias: Living Room Motion Light
  description: "Adaptive motion lighting with power-awareness"
  trigger:
    - platform: state
      entity_id: binary_sensor.sensor_presence
      to: 'on'
      id: motion_on

    - platform: state
      entity_id: binary_sensor.sensor_presence
      to: 'off'
      for: "00:01:00"
      id: motion_off

  condition:
    - condition: state
      entity_id: input_boolean.living_room_power_allowed
      state: 'on'

    - condition: numeric_state
      entity_id: sensor.sensor_illuminance
      below: 150

    # FIX: Removed the sun.sun state condition entirely.
    # It was a test artifact that blocked motion lighting after dark
    # (when sun is below_horizon), which is exactly when it's most needed.

    - condition: state
      entity_id: input_boolean.living_room_motion_enable
      state: 'on'

    - condition: state
      entity_id: input_boolean.living_room_manual_mode
      state: 'off'

  action:
    - choose:
        # ─── MOTION DETECTED ───
        - conditions:
            - condition: trigger
              id: motion_on
          sequence:
            - choose:
                # Night (23:00–06:00) — warm, dim for sleep
                - conditions:
                    - condition: time
                      after: "23:00:00"
                      before: "06:00:00"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.smart_bulb
                      data:
                        brightness_pct: 20
                        # FIX: Was 420K (cool/blue). Changed to 2200K — warm amber
                        # for night time, better for sleep and human circadian rhythm.
                        color_temp_kelvin: 2200
                        transition: 2

                # Evening (18:00–23:00) — warm white, moderate brightness
                - conditions:
                    - condition: time
                      after: "18:00:00"
                      before: "23:00:00"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.smart_bulb
                      data:
                        brightness_pct: 60
                        # FIX: Was 350K. Changed to 3000K — warm white for evening
                        color_temp_kelvin: 3000
                        transition: 3

                # Day (06:00–18:00) — cool white, full brightness
                - conditions:
                    - condition: time
                      after: "06:00:00"
                      before: "18:00:00"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.smart_bulb
                      data:
                        brightness_pct: 90
                        # FIX: Was 250K. Changed to 5000K — cool daylight white
                        color_temp_kelvin: 5000
                        transition: 3

            - service: system_log.write
              data:
                level: info
                message: "Motion lighting activated — Light turned ON at {{ now().strftime('%H:%M:%S') }}"

        # ─── MOTION CLEARED ───
        - conditions:
            - condition: trigger
              id: motion_off
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.smart_bulb

            - service: system_log.write
              data:
                level: info
                message: "Motion lighting turned off — Light turned OFF at {{ now().strftime('%H:%M:%S') }}"

  mode: restart              


# 3. Circadian Lighting Automation (Standalone)

- id: "circadian_lighting"
  alias: Living Room Circadian Lighting
  description: "Continuously adapts light color and brightness based on sun position"
  trigger:
    - platform: time_pattern
      minutes: "/02"   # every 2 minutes

  condition:
    - condition: state
      entity_id: light.smart_bulb
      state: 'on'

    - condition: state
      entity_id: input_boolean.living_room_power_allowed
      state: 'on'

    - condition: state
      entity_id: input_boolean.living_room_manual_mode
      state: 'off'

  action:
    - variables:
        sun_elevation: "{{ state_attr('sun.sun', 'elevation') | float }}"
        brightness: >
          {% set elev = sun_elevation | float %}
          {% if elev < -6 %}
            20
          {% elif elev < 0 %}
            40
          {% elif elev < 20 %}
            70
          {% else %}
            90
          {% endif %}
        color_temp: >
          {% set elev = sun_elevation | float %}
          {% if elev < -6 %}
            420
          {% elif elev < 0 %}
            370
          {% elif elev < 20 %}
            300
          {% else %}
            250
          {% endif %}

    - service: light.turn_on
      target:
        entity_id: light.smart_bulb
      data:
        brightness_pct: "{{ brightness }}"
        color_temp_kelvin: "{{ color_temp }}"
        transition: 15

    - service: system_log.write
      data:
        level: info
        message: >
          Circadian update → brightness {{ brightness }}%, color_temp {{ color_temp }} (sun elevation {{ sun_elevation }} at {{ now().strftime('%H:%M:%S') }})

  mode: single 